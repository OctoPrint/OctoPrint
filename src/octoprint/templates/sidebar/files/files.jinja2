<div class="btn-group storage-selector"
     data-bind="foreach: Object.values($root.storageOptions())"
     data-test-id="storage-selector">
    <button class="btn btn-small"
            data-bind="text: name, click: function() { $root.changeStorage($data.key) }, css: {active: $root.currentStorage() === $data.key}, attr: {'data-test-id': `storage-selector-${$data.key}` }">
    </button>
</div>

<form class="form-search"
      data-bind="submit: performSearch, visible: $root.loginState.hasPermissionKo($root.access.permissions.FILES_LIST)">
    <div class="search-query-with-clear"
         data-bind="css: {'active-clear': searchQuery}">
        <input type="search"
               class="input-block search-query"
               data-bind="value: searchQuery, valueUpdate: 'input'"
               placeholder="{{ _('Search...') |edq }}"
               spellcheck="false">
        <span class="search-clear" data-bind="click: clearSearchQuery"><i class="fas fa-times"></i></span>
    </div>
</form>

<div class="gcode_files"
     data-test-id="files-list"
     data-bind="visible: $root.loginState.hasPermissionKo($root.access.permissions.FILES_LIST)">
    <div class="entry back clickable"
         data-bind="visible: currentPath() != '', click: function() { $root.navigateUp(); }"
         style="display: none">
        <div class="back-arrow">
            <i class="fas fa-arrow-left"></i> {{ _("Back") }}
        </div>
        <div class="back-path">
            <small class="muted">{{ _("Currently in") }} <span data-bind="text: currentPath"></span></small>
        </div>
    </div>

    <div class="scroll-wrapper" data-bind="foreach: filesAndFolders">
        <div class="entry"
             data-bind="attr: { id: $root.getEntryId($data) }, template: { name: $root.templateFor($data), data: $data }, css: $data.type">
        </div>
    </div>

    <script type="text/html" id="files_template_machinecode">
        <div class="file-entry-header">
            <div role="heading" aria-level="3" class="title clickable" data-bind="attr: { title: display }, click: function() { if ($root.enableSelect($data)) { $root.loadFile($data, false); } else { return; } }, css: $root.getSuccessClass($data), style: { 'font-weight': $root.listHelper.isSelected($data) ? 'bold' : 'normal' }"><i data-bind="class: $root.iconForData($data)"></i>&nbsp;<span data-bind="text: display"></span></div>
            <div class="btn btn-mini toggleAdditionalData" data-bind="click: function() { if ($root.enableAdditionalData($data)) { $root.toggleAdditionalData($data); } else { return; } }, css: { disabled: !$root.enableAdditionalData($data) }" title="{{ _('Additional data')|edq }}"><i class="fas fa-chevron-down"></i></div>
        </div>
        <div class="file-entry-content" data-bind="style: { 'flex-direction': $root.contentFlexDirection() }">
            <div class="file-entry-thumbnail clickable" data-bind="style: { width: $root.thumbnailsContainerWidth, 'text-align': $root.thumbnailsAlignment, display: ($root.thumbnailLink($data) && $root.loginState.hasPermissionKo($root.access.permissions.FILES_DOWNLOAD) && $root.thumbnailsEnabled()) ? 'block' : 'none' }">
                <img loading="lazy" data-bind="attr: { src: $root.thumbnailLink($data) }, style: { 'max-width': $root.thumbnailsWidth }, popover: { placement: 'right', title: '{{ _("Preview") | esq }}', html: true, content: $root.thumbnailPopover($data), container: 'body', trigger: $root.thumbnailPopoverTrigger }">
            </div>
            <div class="file-entry-meta">
                <div class="internal" data-bind="visible: display && name != display && $root.showInternalFilename">{{ _('Internal') }}: <span data-bind="text: name"></span></div>
                <div class="uploaded">{{ _('Updated') }}: <span data-bind="text: formatDate(date, {placeholder:'{{ _('unknown')|esq }}'})"></span></div>
                <div class="size">{{ _('Size') }}: <span data-bind="text: formatSize(size)"></span></div>
                <div class="additionalInfo hide" data-bind="html: $root.getAdditionalData($data)"></div>
            </div>
        </div>
        <div class="file-entry-footer">
            <div class="btn-group action-buttons">
                <a class="btn btn-mini btn-files-download" data-bind="visible: $root.loginState.hasPermissionKo($root.access.permissions.FILES_DOWNLOAD), attr: {href: $root.downloadLink($data)}, css: {disabled: !$root.downloadLink($data)}" title="{{ _('Download')|edq }}" aria-label="{{ _('Download')|edq }}"><i class="fas fa-download"></i></a>
                <div class="btn btn-mini btn-files-thumbnail" data-bind="visible: $root.thumbnailLink($data) && $root.loginState.hasPermissionKo($root.access.permissions.FILES_DOWNLOAD), click: function() { $root.showThumbnailPreview($data) }" role="link"><i class="fas fa-image"></i></div>
                <div class="btn btn-mini btn-files-move" data-bind="visible: $root.loginState.hasAllPermissionsKo($root.access.permissions.FILES_UPLOAD, $root.access.permissions.FILES_DELETE), click: function(data, event) { if ($root.enableMove($data)) { $root.showMoveDialog($data, event); } else { return; } }, css: {disabled: !$root.enableMove($data)}" title="{{ _('Move or Rename')|edq }}" aria-label="{{ _('Move or Rename')|edq }}" role="link"><i class="fas fa-cut"></i></div>
                <div class="btn btn-mini btn-files-delete" data-bind="visible: $root.loginState.hasPermissionKo($root.access.permissions.FILES_DELETE), click: function(data, event) { if ($root.enableRemove($data)) { $root.removeFile($data, event); } else { return; } }, css: {disabled: !$root.enableRemove($data)}" title="{{ _('Remove')|edq }}" aria-label="{{ _('Remove')|edq }}" role="link"><i class="far fa-trash-alt"></i></div>
                <div class="btn btn-mini btn-files-select" data-bind="visible: $root.loginState.hasPermissionKo($root.access.permissions.FILES_SELECT), click: function() { if ($root.enableSelect($data)) { $root.loadFile($data, false); } else { return; } }, css: {disabled: !$root.enableSelect($data)}" title="{{ _('Load')|edq }}" aria-label="{{ _('Load')|edq }}" role="link"><i class="fas fa-folder-open"></i></div>
                <div class="btn btn-mini btn-files-print" data-bind="visible: $root.loginState.hasPermissionKo($root.access.permissions.PRINT), click: function() { if ($root.enableSelectAndPrint($data)) { $root.loadFile($data, true); } else { return; } }, css: {disabled: !$root.enableSelectAndPrint($data)}" title="{{ _('Load and Print')|edq }}" aria-label="{{ _('Load and Print')|edq }}" role="link"><i class="fas fa-print"></i></div>
            </div>
        </div>
        <div style="clear: both"></div>
    </script>

    <script type="text/html" id="files_template_model">
        <div class="file-entry-header">
            <div class="title muted" data-bind="text: display, attr: { title: display }"></div>
        </div>
        <div class="file-entry-content" data-bind="style: { 'flex-direction': $root.contentFlexDirection() }">
            <div class="file-entry-thumbnail" data-bind="style: { width: $root.thumbnailsContainerWidth, 'text-align': $root.thumbnailsAlignment, display: ($root.thumbnailLink($data) && $root.loginState.hasPermissionKo($root.access.permissions.FILES_DOWNLOAD) && $root.thumbnailsEnabled()) ? 'block' : 'none' }, class: $root.thumbnailsContainerClass">
                <img loading="lazy" data-bind="attr: { src: $root.thumbnailLink($data) }, style: { 'max-width': $root.thumbnailsWidth }, popover: { placement: 'right', title: '{{ _("Preview") | esq }}', html: true, content: $root.thumbnailPopover($data), container: 'body', trigger: $root.thumbnailPopoverTrigger }">
            </div>
            <div class="file-entry-meta">
                <div class="internal" data-bind="visible: name != display">{{ _('Internal') }}: <span data-bind="text: name"></span></div>
                <div class="uploaded">{{ _('Updated') }}: <span data-bind="text: formatDate(date, {placeholder:'{{ _('unknown')|esq }}'})"></span></div>
                <div class="size">{{ _('Size') }}: <span data-bind="text: formatSize(size)"></span></div>
            </div>
        </div>
        <div class="file-entry-footer">
            <div class="btn-group action-buttons">
                <a class="btn btn-mini btn-files-download" data-bind="visible: $root.loginState.hasPermissionKo($root.access.permissions.FILES_DOWNLOAD), attr: {href: $root.downloadLink($data), css: {disabled: !$root.downloadLink($data)}}" title="{{ _('Download')|edq }}" aria-label="{{ _('Download')|edq }}" role="link"><i class="fas fa-download"></i></a>
                <div class="btn btn-mini btn-files-thumbnail" data-bind="visible: $root.thumbnailLink($data) && $root.loginState.hasPermissionKo($root.access.permissions.FILES_DOWNLOAD), popover: { placement: 'right', title: '{{ _("Preview") | esq }}', html: true, content: $root.thumbnailPopover($data), container: 'body', trigger: 'click' }" role="link"><i class="fas fa-image"></i></div>
                <div class="btn btn-mini btn-files-move" data-bind="visible: $root.loginState.hasAllPermissionsKo($root.access.permissions.FILES_UPLOAD, $root.access.permissions.FILES_DELETE), click: function(data, event) { if ($root.enableMove($data)) { $root.showMoveDialog($data, event); } else { return; } }, css: {disabled: !$root.enableMove($data)}" title="{{ _('Move')|edq }}" aria-label="{{ _('Move')|edq }}" role="link"><i class="fas fa-cut"></i></div>
                <div class="btn btn-mini btn-files-delete" data-bind="visible: $root.loginState.hasPermissionKo($root.access.permissions.FILES_DELETE), click: function(data, event) { if ($root.enableRemove($data)) { $root.removeFile($data, event); } else { return; } }, css: {disabled: !$root.enableRemove($data)}" title="{{ _('Remove')|edq }}" aria-label="{{ _('Remove')|edq }}" role="link"><i class="far fa-trash-alt"></i></div>
                <div class="btn btn-mini btn-files-slice"  data-bind="visible: $root.loginState.hasPermissionKo($root.access.permissions.SLICE), click: function() { if ($root.enableSlicing($data)) { $root.sliceFile($data); } else { return; } }, css: {disabled: !$root.enableSlicing($data)}" title="{{ _('Slice')|edq }}" aria-label="{{ _('Slice')|edq }}" role="link"><i class="fas fa-magic"></i></div>
            </div>
        </div>
    </script>

    <script type="text/html" id="files_template_folder">
        <div class="file-entry-header">
            <div class="title clickable" data-bind="click: $root.changeFolder, style: { 'font-weight': $root.listHelper.isSelected($data) ? 'bold' : 'normal' }"><i class="fas fa-folder-open"></i> <span data-bind="text: display"></span></div>
            <div class="btn btn-mini toggleAdditionalData" data-bind="visible: origin != 'printer',click: function() { if ($root.enableAdditionalData($data)) { $root.toggleAdditionalData($data); } else { return; } }, css: { disabled: !$root.enableAdditionalData($data) }" title="{{ _('Additional data')|edq }}"><i class="fas fa-chevron-down"></i></div>
        </div>
        <div class="file-entry-content" data-bind="style: { 'flex-direction': $root.contentFlexDirection() }">
            <div class="file-entry-meta">
                <div class="internal" data-bind="visible: name != display">{{ _('Internal') }}: <span data-bind="text: name"></span></div>
                <div class="uploaded">{{ _('Updated') }}: <span data-bind="text: formatDate(date, {placeholder:'{{ _('unknown')|esq }}'})"></span></div>
                <div class="size">{{ _('Size') }}: <span data-bind="text: formatSize(size)"></span></div>
                <div class="additionalInfo hide" data-bind="html: $root.getAdditionalData($data)"></div>
            </div>
        </div>
        <div class="file-entry-footer">
            <div class="btn-group action-buttons">
                <div class="btn btn-mini btn-files-move" data-bind="visible: $root.loginState.hasAllPermissionsKo($root.access.permissions.FILES_UPLOAD, $root.access.permissions.FILES_DELETE), click: function(data, event) { if ($root.enableMove($data)) { $root.showMoveDialog($data, event); } else { return; } }, css: {disabled: !$root.enableMove($data)}" title="{{ _('Move')|edq }}" aria-label="{{ _('Move')|edq }}" role="link"><i class="fas fa-cut"></i></div>
                <div class="btn btn-mini btn-files-delete" data-bind="visible: $root.loginState.hasPermissionKo($root.access.permissions.FILES_DELETE), click: function(data, event) { if ($root.enableRemove($data)) { $root.removeFolder($data, event); } else { return; } }, css: {disabled: !$root.enableRemove($data)}" title="{{ _('Remove')|edq }}" aria-label="{{ _('Remove')|edq }}" role="link"><i class="far fa-trash-alt"></i></div>
            </div>
        </div>
    </script>
</div>
<div class="text-right muted"
     data-bind="attr: {title: diskusageString}, css: {'text-error': diskusageCritical}, style: {'font-weight': diskusageCritical() || diskusageWarning() ? 'bold' : 'normal'}, visible: $root.loginState.hasPermissionKo($root.access.permissions.FILES_LIST) && $root.currentStorageHasUsage()">
    <small>{{ _("Free") }}: <span data-bind="text: freeSpaceString"></span> / {{ _("Total") }}: <span data-bind="text: totalSpaceString"></span> <i class="fas fa-exclamation-triangle"
    data-bind="visible: diskusageWarning"
    style="display: none"></i></small>
</div>
<div style="display: none"
     data-bind="visible: loginState.hasPermissionKo(access.permissions.FILES_UPLOAD)">
    <div class="row-fluid folder-button">
        <button class="btn addfolder-button span12"
                data-bind="click: function() { if ($root.currentStorageCanAddFolder()) { $root.showAddFolderDialog() } }, enable: $root.currentStorageCanAddFolder(), css: {disabled: !$root.currentStorageCanAddFolder()}">
            <i class="fas fa-folder"></i> {{ _("Create folder...") }}
        </button>
    </div>
    <div class="row-fluid upload-buttons">
        <span class="btn btn-primary fileinput-button span12"
              style="margin-bottom: 10px"
              data-bind="enable: $root.currentStorageCanUpload(), css: {disabled: !$root.currentStorageCanUpload()}">
            <i class="fas fa-upload"></i>
            <span>{{ _("Upload") }}</span>
            <input id="gcode_upload"
                   data-test-id="upload"
                   accept="{{ ",".join(supportedExtensions) }}"
                   type="file"
                   name="file"
                   class="fileinput-button"
                   multiple
                   data-bind="enable: $root.currentStorageCanUpload()">
        </span>
    </div>
    <div id="gcode_upload_progress" class="progress progress-text-centered">
        <div class="bar"></div>
        <span class="progress-text-back"
              data-bind="css: { 'progress-text-front': (uploadProgressPercentage() >= 50), 'progress-text-back': (uploadProgressPercentage() < 50) }, text: uploadProgressText()"></span>
    </div>
    <div>
        <small class="muted">{{ _("Hint: You can also drag and drop files on this page to upload them to the currently selected storage (if upload is supported).") }}</small>
    </div>
</div>
