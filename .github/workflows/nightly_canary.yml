name: "Nightly Canary"

# Runs nightly canary tests
#
# Currently "simulates" a 32bit RPi in a docker container (armhf7, debian + rpi apt repo + piwheels),
# installs OctoPrint in a basic venv, runs the container and fires the E2E test suite against
# it, also checking the logs for errors.
#
# This should hopefully allow to discover issues with broken dependencies pulled in from piwheels
# very early.

on:
  schedule:
    - cron: "0 1 * * *"
  workflow_dispatch:

jobs:
  canary-e2e:
    name: üé≠ Canary E2E
    runs-on: ${{ matrix.arch.runner }}
    strategy:
      fail-fast: false
      matrix:
        octo_ref:
          - main
          - bugfix
          - dev
        debian_version:
          - bullseye
          - bookworm
          - trixie
        arch:
          - docker: arm/v7
            variant: arm32v7
            runner: ubuntu-latest
            build_type: raspi
        #  - docker: arm64/v8
        #    variant: arm64v8
        #    runner: ubuntu-latest-arm
        #    build_type: raspi
        #  - docker: amd64
        #    variant: amd64
        #    runner: ubuntu-latest
        #    build_type: generic

    steps:
      - name: ‚¨á Checkout
        uses: actions/checkout@v5
        with:
          path: OctoPrint
          ref: ${{ matrix.octo_ref }}
          fetch-depth: 0
          fetch-tags: true

      - name: üèó Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: üèó Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: üèó Prepare E2E config
        run: |
          mkdir e2econfig

          if [ -d OctoPrint/.github/ci/e2econfig ]; then
            cp -r OctoPrint/.github/ci/e2econfig/* e2econfig
          else
            cp -r OctoPrint/.github/fixtures/with_acl/* e2econfig
          fi

          tree e2econfig

          # disable the discovery plugin as its attempt to use multicast will cause an error under docker/qemu:
          #     OSError: [Errno 92] Protocol not available
          # see https://gitlab.com/qemu-project/qemu/-/issues/1837
          yq -i '.plugins._disabled |= . + ["discovery"]' e2econfig/config.yaml

      - name: üèó Prepare docker build
        run: |
          if [ -d OctoPrint/.github/ci/nightly_canary ]; then
            dockerfile="${{ github.workspace }}/OctoPrint/.github/ci/nightly_canary/Dockerfile"
          else
            # we've checked out a ref that doesn't yet have the canary workflow, let's fetch the needed Dockerfile
            curl -L -o Dockerfile "https://raw.githubusercontent.com/OctoPrint/OctoPrint/refs/heads/dev/.github/ci/nightly_canary/Dockerfile"
            dockerfile="${{ github.workspace }}/Dockerfile"
          fi
          echo "Set Dockerfile to $dockerfile"

          echo "DOCKERFILE=$dockerfile" >> $GITHUB_ENV

      - name: üê≥ Build Dockerfile (1st try)
        id: dockerbuild_1
        continue-on-error: true
        uses: docker/build-push-action@v6
        with:
          context: ${{ github.workspace }}/OctoPrint
          file: ${{ env.DOCKERFILE }}
          push: false
          load: true
          tags: octoprint_test:latest
          target: runtime
          build-args: |
            DOCKER_ARCH=${{ matrix.arch.docker }}
            DEBIAN_VERSION=${{ matrix.debian_version }}
            BUILD_TYPE=${{ matrix.arch.build_type }}
          cache-from: type=gha,scope=build-${{ matrix.octo_ref }}-${{ matrix.debian_version }}-${{ matrix.arch.variant }}-${{ matrix.arch.build_type }}
          cache-to: type=gha,mode=max,scope=build-${{ matrix.octo_ref }}-${{ matrix.debian_version }}-${{ matrix.arch.variant }}-${{ matrix.arch.build_type }}
          no-cache-filters: |
            build
            runtime

      - name: üê≥ Build Dockerfile (2nd try)
        id: dockerbuild_2
        continue-on-error: true
        if: steps.dockerbuild_1.outcome != 'success'
        uses: docker/build-push-action@v6
        with:
          context: ${{ github.workspace }}/OctoPrint
          file: ${{ env.DOCKERFILE }}
          push: false
          load: true
          tags: octoprint_test:latest
          target: runtime
          build-args: |
            DOCKER_ARCH=${{ matrix.arch.docker }}
            DEBIAN_VERSION=${{ matrix.debian_version }}
            BUILD_TYPE=${{ matrix.arch.build_type }}
          cache-from: type=gha,scope=build-${{ matrix.octo_ref }}-${{ matrix.debian_version }}-${{ matrix.arch.variant }}-${{ matrix.arch.build_type }}
          cache-to: type=gha,mode=max,scope=build-${{ matrix.octo_ref }}-${{ matrix.debian_version }}-${{ matrix.arch.variant }}-${{ matrix.arch.build_type }}
          no-cache-filters: |
            build
            runtime

      - name: üê≥ Build Dockerfile (3rd & final try)
        id: dockerbuild_3
        if: steps.dockerbuild_1.outcome != 'success' && steps.dockerbuild_2.outcome != 'success'
        uses: docker/build-push-action@v6
        with:
          context: ${{ github.workspace }}/OctoPrint
          file: ${{ env.DOCKERFILE }}
          push: false
          load: true
          tags: octoprint_test:latest
          target: runtime
          build-args: |
            DOCKER_ARCH=${{ matrix.arch.docker }}
            DEBIAN_VERSION=${{ matrix.debian_version }}
            BUILD_TYPE=${{ matrix.arch.build_type }}
          cache-from: type=gha,scope=build-${{ matrix.octo_ref }}-${{ matrix.debian_version }}-${{ matrix.arch.variant }}-${{ matrix.arch.build_type }}
          cache-to: type=gha,mode=max,scope=build-${{ matrix.octo_ref }}-${{ matrix.debian_version }}-${{ matrix.arch.variant }}-${{ matrix.arch.build_type }}
          no-cache-filters: |
            build
            runtime

      - name: üêô Start OctoPrint server in docker
        run: |
          docker run -d --network=host --platform=linux/${{ matrix.arch.docker }} -v ./e2econfig:/octoprint/config octoprint_test

      - name: "üé≠ Run E2E tests"
        uses: OctoPrint/actions/e2e@main
        with:
          server: "http://127.0.0.1:5000"
          ref: "${{ matrix.octo_ref }}"
          suffix: "-${{ matrix.octo_ref }}-${{ matrix.debian_version }}-${{ matrix.arch.variant }}-${{ matrix.arch.build_type }}"
