name: "üê¶ Nightly Canary"

# Runs nightly canary tests
#
# Currently "simulates" a 32bit RPi in a docker container (armhf7, debian + rpi apt repo + piwheels),
# installs OctoPrint in a basic venv, runs the container and fires the E2E test suite against
# it, also checking the logs for errors.
#
# This should hopefully allow to discover issues with broken dependencies pulled in from piwheels
# very early.

on:
  schedule:
    - cron: "0 1 * * *"
  workflow_dispatch:

jobs:
  canary-e2e:
    name: üé≠ Canary E2E
    runs-on: ${{ matrix.arch.runner }}
    strategy:
      fail-fast: false
      matrix:
        debian_version:
          - bullseye
          - bookworm
        #  - trixie
        arch:
          - docker: arm/v7
            variant: arm32v7
            runner: ubuntu-latest
            build_type: raspi
        #  - docker: arm64/v8
        #    variant: arm64v8
        #    runner: ubuntu-latest-arm
        #    build_type: raspi
        #  - docker: amd64
        #    variant: amd64
        #    runner: ubuntu-latest
        #    build_type: generic

    steps:
      - name: ‚¨á Checkout
        uses: actions/checkout@v5
        with:
          path: OctoPrint

      - name: üèó Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: üèó Prepare E2E config
        run: |
          mkdir e2econfig

          if [ -d OctoPrint/.github/ci/e2econfig ]; then
            cp -r OctoPrint/.github/ci/e2econfig/* e2econfig
          else
            cp -r OctoPrint/.github/fixtures/with_acl/* e2econfig
          fi

          tree e2econfig

          # disable the discovery plugin as it's attempt to use multicast will cause an error under docker/qemu:
          #     OSError: [Errno 92] Protocol not available
          # see https://gitlab.com/qemu-project/qemu/-/issues/1837
          yq -i '.plugins._disabled |= . + ["discovery"]' e2econfig/config.yaml

      - name: üê≥ Build Dockerfile (1st try)
        id: dockerbuild_1
        continue-on-error: true
        working-directory: OctoPrint
        run: |
          docker build --target runtime --tag octoprint_test --file .github/ci/nightly_canary/Dockerfile --build-arg DOCKER_ARCH --build-arg DEBIAN_VERSION --build-arg BUILD_TYPE .
        env:
          DEBIAN_VERSION: ${{ matrix.debian_version }}
          DOCKER_ARCH: ${{ matrix.arch.docker }}
          BUILD_TYPE: ${{ matrix.arch.build_type }}
          DOCKER_BUILDKIT: 1

      - name: üê≥ Build Dockerfile (2nd try)
        id: dockerbuild_2
        continue-on-error: true
        if: steps.dockerbuild_1.outcome != 'success'
        working-directory: OctoPrint
        run: |
          docker build --target runtime --tag octoprint_test --file .github/ci/nightly_canary/Dockerfile --build-arg DOCKER_ARCH --build-arg DEBIAN_VERSION --build-arg BUILD_TYPE .
        env:
          DEBIAN_VERSION: ${{ matrix.debian_version }}
          DOCKER_ARCH: ${{ matrix.arch.docker }}
          BUILD_TYPE: ${{ matrix.arch.build_type }}
          DOCKER_BUILDKIT: 1

      - name: üê≥ Build Dockerfile (3rd & final try)
        id: dockerbuild_3
        if: steps.dockerbuild_1.outcome != 'success' && steps.dockerbuild_2.outcome != 'success'
        working-directory: OctoPrint
        run: |
          docker build --target runtime --tag octoprint_test --file .github/ci/nightly_canary/Dockerfile --build-arg DOCKER_ARCH --build-arg DEBIAN_VERSION --build-arg BUILD_TYPE .
        env:
          DEBIAN_VERSION: ${{ matrix.debian_version }}
          DOCKER_ARCH: ${{ matrix.arch.docker }}
          BUILD_TYPE: ${{ matrix.arch.build_type }}
          DOCKER_BUILDKIT: 1

      - name: üêô Start OctoPrint server in docker
        run: |
          docker run -d --network=host --platform=linux/${{ matrix.arch.docker }} -v ./e2econfig:/octoprint/config octoprint_test

      - name: "üé≠ Run E2E tests"
        uses: OctoPrint/actions/e2e@main
        with:
          server: "http://127.0.0.1:5000"
          suffix: "-${{ matrix.debian_version }}-${{ matrix.arch.variant }}"

      - name: üîé Check octoprint.log for errors
        run: |
          log="e2econfig/logs/octoprint.log"
          if grep "\- ERROR \-" $log; then
            echo "::error::Errors were logged to octoprint.log"
            grep -Pazo '(?m)^\N+\- ERROR \-\N*\n(^\N*?\n)*?(?=\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2},\d{3} \- )' $log
            exit 1
          fi
